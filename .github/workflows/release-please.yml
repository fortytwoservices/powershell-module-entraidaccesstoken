name: ReleasePlease
on:
  repository_dispatch:
    types: [create-pull-request]
  pull_request:
  push:
    branches: [ "main" ]

permissions:
  pull-requests: write
  contents: write

jobs:

  update-readme:
    if: github.event_name == 'pull_request'
    name: Update psd1 and documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 2
          ref: ${{ github.event.pull_request.head.ref }}
      - name: Update documentation.md and psd1 version
        shell: pwsh
        run: |
          $Path = ".\Documentation.md"

          # Load platyPS module for generating markdown documentation
          Install-Module platyPS -Scope CurrentUser -Confirm:$false -Force
          Import-Module platyPS
      
          # Locate the module manifest file
          $psd1 = Get-ChildItem -Recurse -Include *.psd1
          $count = ($psd1 | Measure-Object).Count
              if($count -ne 1) {
              Write-Error "Wrong number of psd1 files found ($count)"
              exit 1
          }
      
          # Update the psd1 file with the release-please version
          if((Test-Path ".release-please-manifest.json")) {
              $releasePleaseVersion = (Get-Content ".release-please-manifest.json" | ConvertFrom-Json -AsHashTable)."."
              if($releasePleaseVersion -notlike "*.*.*") {
                  Write-Error "Invalid release-please version '($releasePleaseVersion)' found"
                  exit 1
              }
      
              # Replace the ModuleVersion line in the psd1 file
              (Get-Content $psd1.FullName | 
              ForEach-Object {if($_ -like "*ModuleVersion*=*"){"    ModuleVersion = '$releasePleaseVersion'"} else {$_}} | 
              Out-String).Trim() | 
              Set-Content $psd1.FullName
          }
          
          # Import the module
          $RequiredModules = [ScriptBlock]::Create((Get-Content -Raw $psd1.FullName)).Invoke().RequiredModules
          if($RequiredModules) {
            $RequiredModules | ForEach-Object {New-Module -Name $_ -ScriptBlock {} | Import-Module}
          }
          $ModulePath = $psd1.FullName | Split-Path -Parent
          $Module = Import-Module $ModulePath -Verbose -Force -PassThru
          
          # Generate README.md
          {
              "# Documentation for module $($Module.Name)"
              ""
              $Module.Description
              ""
              "| Metadata | Information |"
              "| --- | --- |"
              "| Version | $($Module.Version) |"
              if($Module.RequiredModules) {"| Required modules | $($Module.RequiredModules) |"}
              if($Module.Author) {"| Author | $($Module.Author) |"}
              if($Module.CompanyName) {"| Company name | $($Module.CompanyName) |"}
              if($Module.PowerShellVersion) {"| PowerShell version | $($Module.PowerShellVersion) |"}
              ""
              
              New-MarkdownHelp -Module $Module.Name -OutputFolder "$($ENV:RUNNER_TEMP)/generateddocs" -Force -NoMetadata |
              Get-Content |
              ForEach-Object {$_ -replace "^#","##"} |
              ForEach-Object {$_ -replace "{{ Fill [\w\s]+ Description }}"}
          }.Invoke() | Out-File -FilePath $Path -Encoding utf8 -Force
      - name: Push back to PR
        env:
          GH_TOKEN: ${{ secrets.MARVIN_PAT }}
          BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          set -e

          # helper to base64-encode without line-wrap
          b64() { base64 -w0 "$1"; }

          # paths
          PSD1_PATH=$(git ls-files '*.psd1')
          README_PATH="README.md"

          # 1) Get current file SHAs on the PR branch
          PSD1_SHA=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/contents/${PSD1_PATH}?ref=${BRANCH}" \
            --jq .sha)

          README_SHA=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/contents/${README_PATH}?ref=${BRANCH}" \
            --jq .sha)

          # 2) Update psd1 (creates a Verified commit)
          gh api \
            -X PUT \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/contents/${PSD1_PATH}" \
            -f message="chore: bump version in psd1" \
            -f content="$(b64 "${PSD1_PATH}")" \
            -f sha="${PSD1_SHA}" \
            -f branch="${BRANCH}"

          # 3) Update README
          gh api \
            -X PUT \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/contents/${README_PATH}" \
            -f message="docs: regenerate README from module metadata" \
            -f content="$(b64 "${README_PATH}")" \
            -f sha="${README_SHA}" \
            -f branch="${BRANCH}"
  release-please:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    steps:
      - uses: googleapis/release-please-action@c2a5a2bd6a758a0937f1ddb1e8950609867ed15c # v4.3.0
        with:
          token: ${{ secrets.MARVIN_PAT }}
          config-file: .github/release-please-config.json
